<!-- Seleção de turma e disciplina -->
<div style="display: flex; gap: 16px; margin-bottom: 16px; align-items: center">
  <!-- Dropdown de Turma -->
  <mat-form-field appearance="fill" style="min-width: 240px">
    <mat-label>Selecione a Turma</mat-label>
    <mat-select [(value)]="turmaSelecionada" (selectionChange)="selecionarTurma($event.value)">
      <mat-option *ngFor="let turma of turmas" [value]="turma.id">
        {{ turma.nome }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Dropdown de Disciplina -->
  <mat-form-field appearance="fill" style="min-width: 240px">
    <mat-label>Selecione a Disciplina</mat-label>
    <mat-select
      [(value)]="disciplinaSelecionada"
      (selectionChange)="selecionarDisciplina($event.value)"
      [disabled]="!turmaSelecionada"
    >
      <mat-option [value]="null">Selecione...</mat-option>
      <mat-option *ngFor="let disciplina of disciplinas" [value]="disciplina.id">
        {{ disciplina.nome }}
      </mat-option>
    </mat-select>
  </mat-form-field>
</div>

<!-- Tabela de notas -->
<table mat-table [dataSource]="alunos" class="mat-elevation-z8" style="width: 100%">
  <!-- Coluna Aluno -->
  <ng-container matColumnDef="aluno">
    <th mat-header-cell *matHeaderCellDef>Aluno</th>
    <td mat-cell *matCellDef="let aluno">{{ aluno.nome }}</td>
  </ng-container>

  <!-- Colunas dinâmicas de avaliação -->
  <ng-container *ngFor="let avaliacao of avaliacoes" [matColumnDef]="'avaliacao-' + avaliacao.id">
    <th mat-header-cell *matHeaderCellDef>
      {{ avaliacao.descricao }} (peso {{ avaliacao.peso }})
    </th>
    <td mat-cell *matCellDef="let aluno">
      <input
        #notaInput
        type="number"
        class="form-control"
        [ngClass]="{ 
          'input-erro': inputsInvalidos.has(aluno.id + '-' + avaliacao.id),
          'input-alterado': notasAlteradas.has(aluno.id + '-' + avaliacao.id)
        }"
        [value]="inputsInvalidos.has(aluno.id + '-' + avaliacao.id) ? '' : getNotaValor(aluno.id, avaliacao.id)"
        (change)="atualizarNota(aluno.id, avaliacao.id, getValorDoEvento($event), notaInput)"
        min="0"
        max="10"
        step="0.1"
        placeholder="-"
      />
    </td>
  </ng-container>

  <!-- Coluna Média -->
  <ng-container matColumnDef="media">
    <th mat-header-cell *matHeaderCellDef>Média</th>
    <td mat-cell *matCellDef="let aluno">
      {{ calcularMedia(aluno.id) }}
    </td>
  </ng-container>

  <!-- Cabeçalho e linhas -->
  <tr mat-header-row *matHeaderRowDef="colunasTabela"></tr>
  <tr mat-row *matRowDef="let row; columns: colunasTabela"></tr>
</table>

<!-- Botão salvar -->
<div style="margin-top: 16px; display: flex; align-items: center; gap: 16px">
  <button
    mat-raised-button
    color="primary"
    (click)="salvarNotas()"
    [disabled]="!turmaSelecionada || !disciplinaSelecionada || notasAlteradas.size === 0 || carregando"
  >
    <span *ngIf="!carregando">Salvar Notas</span>
    <span *ngIf="carregando" style="display: flex; align-items: center; gap: 8px">
      <mat-spinner diameter="20"></mat-spinner>
      Salvando...
    </span>
  </button>
</div>